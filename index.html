<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Drinking game</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <style>
            body {
                background-color: green;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            #wrapper {
                width: 100%;
                height: 100%;
            }
            
            /* Nav */
            #navigation-wrapper {
                width: 100%;
                text-align: center;
            }
            /* Made by http://www.bestcssbuttongenerator.com/ */
            #navigation-wrapper .nav-button {
                -moz-box-shadow:inset 0px 1px 0px 0px #caefab;
                -webkit-box-shadow:inset 0px 1px 0px 0px #caefab;
                box-shadow:inset 0px 1px 0px 0px #caefab;
                background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #77d42a), color-stop(1, #5cb811));
                background:-moz-linear-gradient(top, #77d42a 5%, #5cb811 100%);
                background:-webkit-linear-gradient(top, #77d42a 5%, #5cb811 100%);
                background:-o-linear-gradient(top, #77d42a 5%, #5cb811 100%);
                background:-ms-linear-gradient(top, #77d42a 5%, #5cb811 100%);
                background:linear-gradient(to bottom, #77d42a 5%, #5cb811 100%);
                filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#77d42a', endColorstr='#5cb811',GradientType=0);
                background-color:#77d42a;
                -moz-border-radius:6px;
                -webkit-border-radius:6px;
                border-radius:6px;
                border:1px solid #268a16;
                display:inline-block;
                cursor:pointer;
                color:#306108;
                font-family:arial;
                font-size:15px;
                font-weight:bold;
                padding:6px 24px;
                text-decoration:none;
                text-shadow:0px 1px 0px #aade7c;
            }
            #navigation-wrapper .nav-button:hover {
                background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #5cb811), color-stop(1, #77d42a));
                background:-moz-linear-gradient(top, #5cb811 5%, #77d42a 100%);
                background:-webkit-linear-gradient(top, #5cb811 5%, #77d42a 100%);
                background:-o-linear-gradient(top, #5cb811 5%, #77d42a 100%);
                background:-ms-linear-gradient(top, #5cb811 5%, #77d42a 100%);
                background:linear-gradient(to bottom, #5cb811 5%, #77d42a 100%);
                filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#5cb811', endColorstr='#77d42a',GradientType=0);
                background-color:#5cb811;
            }
            #navigation-wrapper .nav-button:active {
                position:relative;
                top:1px;
            }
            /* End http://www.bestcssbuttongenerator.com/ */
            
            /* Card */
            .current-card-wrapper {
                width: 100%;
            }
            #current-card {
                margin: 25px auto 45px auto;
                width: 254px;
                height: 352px;
                background-color: white;
                -moz-border-radius:10px;
                -webkit-border-radius:10px;
                border-radius: 10px;
                position: relative;
            }
            #card-background {
                width: 100%;
                height: 100%;
                position: absolute;
                text-align: center;
            }
            .card-icon {
                width: 18%;
                height: 22%;
                position: absolute;
                font-size: 45px;
                line-height: 39px;
                text-align: center;
            }
            #upper-card-icon {
                top: 2%;
                left: 2%;
            }
            #lower-card-icon {
                bottom: 2%;
                right: 2%;
                // Rotate for extra nice effect
                -ms-transform: rotate(180deg); /* IE 9 */
                -webkit-transform: rotate(180deg); /* Chrome, Safari, Opera */
                transform: rotate(180deg);
            }
            .card-icon .card-html-icon, .card-icon .card-html-number {
                width: 100%;
            }
            #card-content-wrapper {
                width: 80%;
                height: 100px;
                line-height: 100px;
                position: absolute;
                top: 35%;
                left: 10%;
                -ms-transform: rotate(-45deg); /* IE 9 */
                -webkit-transform: rotate(-45deg); /* Chrome, Safari, Opera */
                transform: rotate(-45deg);
                text-align: center;
            }
            #card-content {
                display: inline-block;
                vertical-align: middle;
                line-height: normal;
                font-size: 30px;
            }

            /* Toolbar */
            #toolbar-wrapper {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background-color: rgba(255,255,255,0.94);
                z-index: 7;
                overflow: auto;
            }
            #toolbar-toggle {
                font-size: 20px;
                background-color: #085F0F;
                color: #3C8044;
                text-align: center;
            }
            #toolbar-content {
                padding: 5px;
            }
            #toolbar-section-headers-wrapper, 
            #toolbar-section-content-wrapper {
                float: left;
                width: 100%;
            }
            .toolbar-section-header {
                float: left;
                margin: 0 5px;
                padding: 3px;
                background-color: #BBDFBE;
                -moz-border-radius:3px;
                -webkit-border-radius:3px;
                border-radius: 3px;
            }
            .toolbar-section-content {
                float: left;
                display: none;
            }
            .debug-number {
                width: 100%;
                display: block;
            }
            
            /* Misc / Global */
            .red {
                color: red;
            }
            .black {
                color: black;
            }
            .bold {
                font-weight: 600;
            }
            #email-icon {
                position: fixed;
                right: 0;
                bottom: 23px;
                width: 44px;
                height: 35px;
                background-color: white;
                border: black 1px solid;
                font-size: 44px;
                line-height: 38px;
            }
            .mail-button:link,
            .mail-button:hover, 
            .mail-button:visited, 
            .mail-button:active {
                color: black;
                text-decoration: none;
                font-size: 44px;
                line-height: 38px;
            }
        </style>
    </head>
    <body>
        <div id="wrapper">
            <div id="navigation-wrapper">
                <a class="nav-button" onclick="deck.getPreviousCard();populateCard(deck.getCurrentCard());">&lt; Föregående kort</a>
                <a class="nav-button" onclick="deck.getNextCard();populateCard(deck.getCurrentCard());">Nästa kort &gt;</a>
                <div id="card-counter">52 kort kvar</div>
            </div>
            <div class="current-card-wrapper">
                <div id="current-card" onclick="deck.getNextCard();populateCard(deck.getCurrentCard());">
                    <div id="card-background"></div>
                    <div id="upper-card-icon" class="card-icon"></div>
                    <div id="card-content-wrapper"><span id="card-content"></span></div>
                    <div id="lower-card-icon" class="card-icon"></div>
                </div>
            </div>
            <div id="card-info-text"></div>
        </div>
        <div id="toolbar-wrapper">
            <div id="toolbar-toggle" onclick="toolBar.toggleToolBar();">Inställningar (visa)</div>
            <div id="toolbar-content" style="display: none;">
                <div id="toolbar-section-wrapper">
                    <div id="toolbar-section-headers-wrapper">
                        <div class="toolbar-section-header" onclick="toolBar.switchTab('card-settings');">Kortinställningar</div>
                        <div class="toolbar-section-header" onclick="toolBar.switchTab('card-statistics');">Statistik</div>
                        <div class="toolbar-section-header" onclick="toolBar.switchTab('information');">Information</div>
                    </div>
                    <div id="toolbar-section-content-wrapper">
                        <div id="card-settings" class="toolbar-section-content" style="display: block;">
                            <table>
                                <tr>
                                    <th>Kort</th><th colspan="2">Regel</th>
                                </tr>
                                <tr>
                                    <th></th>
                                    <th style="color: red;">Röda</th>
                                    <th>Svarta</th>
                                </tr>
                                <tr>
                                    <td>Kung</td>
                                    <td><input type="text" id="13-input-r" name="13-input-r" value="Kung"/></td>
                                    <td><input type="text" id="13-input-s" name="13-input-s" value="Kung"/></td>
                                </tr>
                                <tr>
                                    <td>Dam</td>
                                    <td><input type="text" id="12-input-r" name="12-input-r" value="Kategori"/></td>
                                    <td><input type="text" id="12-input-s" name="12-input-s" value="Kategori"/></td>
                                </tr>
                                <tr>
                                    <td>Knekt</td>
                                    <td><input type="text" id="11-input-r" name="11-input-r" value="Ny regel"/></td>
                                    <td><input type="text" id="11-input-s" name="11-input-s" value="Ny regel"/></td>
                                </tr>
                                <tr>
                                    <td>10</td>
                                    <td><input type="text" id="10-input-r" name="10-input-r" value="Välj nästa spelare"/></td>
                                    <td><input type="text" id="10-input-s" name="10-input-s" value="Välj nästa spelare"/></td>
                                </tr>
                                <tr>
                                    <td>9</td>
                                    <td><input type="text" id="9-input-r" name="9-input-r" value="Vattenfall"/></td>
                                    <td><input type="text" id="9-input-s" name="9-input-s" value="Vattenfall"/></td>
                                </tr>
                                <tr>
                                    <td>8</td>
                                    <td><input type="text" id="8-input-r" name="8-input-r" value="Ny regel"/></td>
                                    <td><input type="text" id="8-input-s" name="8-input-s" value="Ny regel"/></td>
                                </tr>
                                <tr>
                                    <td>7</td>
                                    <td><input type="text" id="7-input-r" name="7-input-r" value="Sifferleken"/></td>
                                    <td><input type="text" id="7-input-s" name="7-input-s" value="Sifferleken"/></td>
                                </tr>
                                <tr>
                                    <td>6</td>
                                    <td><input type="text" id="6-input-r" name="6-input-r" value="Ge 6 klunkar"/></td>
                                    <td><input type="text" id="6-input-s" name="6-input-s" value="Drick 6 klunkar"/></td>
                                </tr>
                                <tr>
                                    <td>5</td>
                                    <td><input type="text" id="5-input-r" name="5-input-r" value="Ge 5 klunkar"/></td>
                                    <td><input type="text" id="5-input-s" name="5-input-s" value="Drick 5 klunkar"/></td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td><input type="text" id="4-input-r" name="4-input-r" value="Ge 4 klunkar"/></td>
                                    <td><input type="text" id="4-input-s" name="4-input-s" value="Drick 4 klunkar"/></td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td><input type="text" id="3-input-r" name="3-input-r" value="Ge 3 klunkar"/></td>
                                    <td><input type="text" id="3-input-s" name="3-input-s" value="Drick 3 klunkar"/></td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td><input type="text" id="2-input-r" name="2-input-r" value="Ge en shot"/></td>
                                    <td><input type="text" id="2-input-s" name="2-input-s" value="Drick en shot"/></td>
                                </tr>
                                <tr>
                                    <td>Äss</td>
                                    <td><input type="text" id="1-input-r" name="1-input-r" value="Ge en shot"/></td>
                                    <td><input type="text" id="1-input-s" name="1-input-s" value="Drick en shot"/></td>
                                </tr>
                            </table>
                        </div>
                        <div id="card-statistics" class="toolbar-section-content">
                            Statistik
                        </div>
                        <div id="information" class="toolbar-section-content">
                            Information om denna app!<br />
                            <br />
                            Denna app bygger på klassiska fyllespelet "vattenfall"/"kung" m.fl.<br />
                            "Kärt barn har många namn".<br />
                            <br />
                            Enda skillnaden är att detta är en digital version av spelet. Naturligtvis finns många varianter (i form av appar) på detta, men jag har valt att göra det till en webbanpass version för att stödja egentligen vilken enhet som helst.<br />
                            Man får gärna skicka in förslag på ändringar (med knappen nedan), trevliga kommentarer t.o.m. hjälpa till och utveckla spelet vidare.<br />
                            <br />
                            <a class="mail-button" href="">&#9993;</a><br />
                            <br />
                            Historik om spelet (s.k. changelog)<br />
                            <ul>
                                <li><span class="bold">2014-09-21</span>: Möjlighet att se statistik infördes i spelet</li>
                                <li><span class="bold">2014-09-20</span>: Stöd för "swipe" i mobila enheter</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <div id="email-icon">
            <a class="mail-button" href="">&#9993;</a>
        </div> -->
        <script type="text/javascript">
            function toolBar(){
                this.toolBarWrapper = document.getElementById('toolbar-wrapper');
                this.toolBarContent = document.getElementById('toolbar-content');
                this.toolBarHeader = document.getElementById('toolbar-toggle');
                this.toolBarIsOpen = false;
                
                this.toggleToolBar = function(){
                    if(this.toolBarIsOpen){
                        this.closeToolBar();
                    } else {
                        this.openToolBar();
                    }
                }
                
                this.openToolBar = function(){
                    this.toolBarContent.style.display = 'block';
                    this.toolBarWrapper.style.height = '100%';
                    this.toolBarHeader.innerHTML = 'Inställningar (dölj)';
                    this.toolBarIsOpen = true;
                }
                
                this.closeToolBar = function(){
                    this.toolBarContent.style.display = 'none';
                    this.toolBarHeader.innerHTML = 'Inställningar (visa)';
                    this.toolBarWrapper.style.height = 'initial';
                    this.toolBarIsOpen = false;
                }
                
                this.switchTab = function(tabId){
                    // First, close all tabs
                    var elements = document.getElementById('toolbar-section-content-wrapper').children, i;
                    for(i=0;i<elements.length;++i){
                        elements[i].style.display = 'none';
                    }
                    
                    // Open tab
                    document.getElementById(tabId).style.display = 'block';
                }
            }
            
            function populateCard(card){
                var cardHtml = deck.parseCardToHtml(card), 
                    cardBackgroundHtml = deck.parseCardToBackgroundHtml(card), 
                    iconDivs = document.getElementsByClassName('card-icon'), 
                    cardColor = deck.getCardColor(card), 
                    i;
            
                for(i=0;i<iconDivs.length;++i){
                    iconDivs[i].innerHTML = cardHtml;
                }
                card = card.substring(1);
                if(document.getElementById(card+'-input-'+cardColor) !== ''){
                    document.getElementById('card-content').innerHTML = document.getElementById(card+'-input-'+cardColor).value;
                } else {
                    document.getElementById('card-content').innerHTML = document.getElementById(card+'-input').value;
                }
                // document.getElementById('card-background').innerHTML = cardBackgroundHtml;
                document.getElementById('card-counter').innerHTML = deck.getCardsLeft()+' kort kvar';
                
                document.getElementById('card-statistics').innerHTML = deck.getDealtCardStatistics();
            }
            
            // Whole deck logic
            function cardDeck() {
                this.cards = [
                    // Clubs
                    'c1','c2','c3','c4','c5','c6','c7','c8','c9','c10','c11','c12','c13',
                    // Spades
                    's1','s2','s3','s4','s5','s6','s7','s8','s9','s10','s11','s12','s13',
                    // Hearts
                    'h1','h2','h3','h4','h5','h6','h7','h8','h9','h10','h11','h12','h13',
                    // Diamonds
                    'd1','d2','d3','d4','d5','d6','d7','d8','d9','d10','d11','d12','d13'
                ];
                this.currentCard;
                this.cardDirection = [];
                this.dealtCards = [];
                
                this.shuffleDeck = function(){
                    // Thank you CoolAJ86 for pure cs shuffle script
                    // http://stackoverflow.com/a/2450976
                    array = this.cards;
                    var currentIndex = array.length, tempVal, randIndex;
                    
                    while(currentIndex !== 0){
                        randIndex = Math.floor(Math.random() * currentIndex);
                        --currentIndex;
                        
                        tempVal = array[currentIndex];
                        array[currentIndex] = array[randIndex];
                        array[randIndex] = tempVal;
                    }
                    
                    this.cardDirection = array;
                }
                
                this.getNextCard = function(){
                    // Check if we actually have cards left
                    if(this.cardDirection.length > 0){
                        // Move current card to dealt pool
                        this.dealtCards.push(this.currentCard);

                        // Get new current card
                        this.currentCard = this.cardDirection[0];
                        
                        // Remove that card from dealing pool
                        this.cardDirection.splice(0,1);

                        return this.currentCard;
                    }
                }
                
                this.getPreviousCard = function(){
                    // Only do something if we have a previous card aka a dealt card
                    if(this.dealtCards.length > 0){
                        // Put current card back into dealing deck
                        this.cardDirection.unshift(this.currentCard);
                        
                        // Retrive last card from dealt deck
                        this.currentCard = this.dealtCards[this.dealtCards.length-1];

                        // Remove "current" card from dealt pool
                        this.dealtCards.pop();

                        return this.currentCard;
                    }
                }
                
                this.getCurrentCard = function(){
                    return this.currentCard;
                }
                
                this.getCardsLeft = function(){
                    return this.cardDirection.length;
                }
                
                this.parseCardToHtml = function(cardId){
                    var cardType, outHtml;
                
                    cardType = this.getCardType(cardId);
                    cardId = this.parseSpecialCard(cardId);
                    // Determinate color
                    colorClass = (cardType === '&spades;' || cardType === '&clubs;'?'black':'red');
                    // Little html parse, rather than splitting outside function
                    outHtml = '<div class="card-html-number '+colorClass+'">'+cardId+'</div>'+
                            '<div class="card-html-icon '+colorClass+'">'+cardType+'</div>';
                    
                    return outHtml;
                }
                
                this.parseCardToBackgroundHtml = function(cardId){
                    var cardType = this.getCardType(cardId), 
                        outHtml;
                
                    cardId = this.parseSpecialCard(cardId);
                    
                    // How do we solve king, dame and knight background?
                    if(isNaN(cardId)){
                        return 'img somehow';
                    }
                    
                    // Fancy function for painting fancy patterns
                    
                    return '<div class="row">'+
                            '<span class="background-icon">'+cardType+'</span>'+
                        '</div>';
                }
                
                this.parseSpecialCard = function(cardId){
                    // Remove cardType letter so we only have number left
                    cardId = cardId.substring(1);
                    // Check for specials like king, dame or knight
                    switch(cardId){
                        case '11':
                            cardId = 'J';
                            break;
                            
                        case '12':
                            cardId = 'D';
                            break;
                            
                        case '13':
                            cardId = 'K';
                            break;
                            
                        default:
                            break;
                    }
                    
                    return cardId;
                }
                
                this.getCardType = function(cardId){
                    var cardType;
                    // Check card for "type"
                    // Spades
                    if(cardId.indexOf('s') !== -1){
                        cardType = '&spades;';
                    } else
                    // Clubs
                    if(cardId.indexOf('c') !== -1){
                        cardType = '&clubs;';
                    } else 
                    // Hearts
                    if(cardId.indexOf('h') !== -1){
                        cardType = '&hearts;';
                    } else 
                    // Diamonds
                    if(cardId.indexOf('d') !== -1){
                        cardType = '&diams;';
                    }
                
                    return cardType;
                }
                
                this.getDealtCardStatistics = function(){
                    var cards = this.dealtCards, 
                        currentCard, 
                        currentCountingCard, 
                        cardStatistics = [0,0,0,0,0,0,0,0,0,0,0,0,0],
                        outHtml = '<table><tr><th colspan="2">Antal kort som spelats</th></tr>', 
                        i;
                    
                    // 1st occurence will always be a undefined
                    for(i=1;i<cards.length;++i){
                        currentCountingCard = (cards[i].substring(1))-1;
                        cardStatistics[currentCountingCard] = cardStatistics[currentCountingCard]+1;
                    }
                    
                    // Add "current" card to cards for proper display
                    currentCard = (this.getCurrentCard().substring(1))-1;
                    cardStatistics[currentCard] = cardStatistics[currentCard]+1;

                    for(i=1;i<=cardStatistics.length;++i){
                        // We add "K" to parses, since it expect cardId formats (s4, c13 and such)
                        outHtml += '<tr><td style="width: 30px;">'+this.parseSpecialCard('K'+i)+'</td>'
                                +'<td>'+cardStatistics[i-1]+'</td></tr>';
                    }
                    outHtml += '</table>';

                    return outHtml;
                }
                
                // Gets card color (s/r)
                this.getCardColor = function(cardName){
                    var cardColor;
                    
                    // Spades
                    if(cardName.indexOf('s') !== -1){
                        cardColor = 's';
                    } else
                    // Clubs
                    if(cardName.indexOf('c') !== -1){
                        cardColor = 's';
                    } else 
                    // Hearts
                    if(cardName.indexOf('h') !== -1){
                        cardColor = 'r';
                    } else 
                    // Diamonds
                    if(cardName.indexOf('d') !== -1){
                        cardColor = 'r';
                    }
                
                    return cardColor;
                }
            }
            
            function mailer() {
                this.addEmails = function(){
                    var mailLinks = document.getElementsByClassName('mail-button'), i;
                    for(i=0;i<mailLinks.length;++i){
                        mailLinks[i].href = 'mailto:'+this.createEncodedEmail();
                    }
                }
                
                this.createEncodedEmail = function(){
                    var a = 'admin';
                    var b = 'klorixx';
                    var c = '.se';
                    var d = '@';

                    return a+d+b+c;
                }
            }
            
            // Lib found at http://www.javascriptkit.com/javatutors/touchevents2.shtml
            function swipedetect(el, callback){
                var touchsurface = el,
                swipedir,
                startX,
                startY,
                distX,
                distY,
                threshold = 150, //required min distance traveled to be considered swipe
                restraint = 100, // maximum distance allowed at the same time in perpendicular direction
                allowedTime = 300, // maximum time allowed to travel that distance
                elapsedTime,
                startTime,
                handleswipe = callback || function(swipedir){}

                touchsurface.addEventListener('touchstart', function(e){
                    var touchobj = e.changedTouches[0]
                    swipedir = 'none'
                    dist = 0
                    startX = touchobj.pageX;
                    startY = touchobj.pageY;
                    startTime = new Date().getTime() // record time when finger first makes contact with surface
                    e.preventDefault()
                }, false);

                touchsurface.addEventListener('touchmove', function(e){
                    e.preventDefault() // prevent scrolling when inside DIV
                }, false);

                touchsurface.addEventListener('touchend', function(e){
                    var touchobj = e.changedTouches[0]
                    distX = touchobj.pageX - startX; // get horizontal dist traveled by finger while in contact with surface
                    distY = touchobj.pageY - startY; // get vertical dist traveled by finger while in contact with surface
                    elapsedTime = new Date().getTime() - startTime // get time elapsed
                    if (elapsedTime <= allowedTime){ // first condition for awipe met
                        if (Math.abs(distX) >= threshold && Math.abs(distY) <= restraint){ // 2nd condition for horizontal swipe met
                            swipedir = (distX < 0)? 'left' : 'right' // if dist traveled is negative, it indicates left swipe
                        } else if (Math.abs(distY) >= threshold && Math.abs(distX) <= restraint){ // 2nd condition for vertical swipe met
                            swipedir = (distY < 0)? 'up' : 'down' // if dist traveled is negative, it indicates up swipe
                        }
                    }
                    handleswipe(swipedir)
                    e.preventDefault()
                }, false);
           }
            
            var deck, 
                toolBar, 
                mailer, 
                lastTouchEvent, 
                xDown = null, 
                yDown = null;
            
            function initiateGame(){                
                // Initiate toolbar
                toolBar = new toolBar();
                
                // Initiate deck
                deck = new cardDeck();
                deck.shuffleDeck();
                
                // Create mail hrefs
                mailer = new mailer();
                mailer.addEmails();
                
                // Add swipe listeners
                swipedetect(document.getElementById('wrapper'),function(cb){
                    if(cb === 'left'){
                        deck.getNextCard();
                    }
                    if(cb === 'right'){
                        deck.getPreviousCard();
                    }
                    if(cb === 'right' || cb === 'left'){
                        populateCard(deck.getCurrentCard());
                    }
                    
                    if(cb === 'up'){
                        toolBar.openToolBar();
                    }
                    if(cb === 'down'){
                        toolBar.closeToolBar();
                    }
                });
            }
            
            window.onload = initiateGame();
        </script>
    </body>
</html>
